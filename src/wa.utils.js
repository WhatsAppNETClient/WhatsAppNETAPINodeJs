require("dotenv").config();const{CHROME_PATH:CHROME_PATH,SESSION_ID:SESSION_ID}=process.env,path=require("path"),fs=require("fs"),{waitFor:waitFor}=require("./utils"),{Client:Client,MessageMedia:MessageMedia}=require("whatsapp-web.js"),SESSION_FILE_PATH=path.join(path.resolve("./session"),`${SESSION_ID}.json`),QRCODE_FILE_PATH=path.join(path.resolve("./session"),`qr_code_${SESSION_ID}.png`);let sessionCfg;fs.existsSync(SESSION_FILE_PATH)&&(sessionCfg=require(SESSION_FILE_PATH));const client=new Client({puppeteer:{headless:!0,executablePath:CHROME_PATH},session:sessionCfg}),{signalRClient:signalRClient,serverHub:serverHub}=require("./signalr.util"),qr=require("qr-image");client.on("qr",e=>{const s="- Scan QRCode...";console.log(s);var n=qr.imageSync(e,{type:"png"});fs.writeFileSync(QRCODE_FILE_PATH,n),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:s,sessionId:SESSION_ID})),signalRClient.connection.hub.invoke(serverHub,"ScanMe",JSON.stringify({qrcodePath:QRCODE_FILE_PATH,sessionId:SESSION_ID}))}),client.on("authenticated",e=>{const s="- Authenticated";console.log(s),fs.writeFile(SESSION_FILE_PATH,JSON.stringify(e),e=>{e&&console.error(e)}),fs.existsSync(QRCODE_FILE_PATH)&&fs.unlink(QRCODE_FILE_PATH,e=>{e&&console.log(e),console.log(`${QRCODE_FILE_PATH} is deleted!`)}),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:s,sessionId:SESSION_ID}))}),client.on("auth_failure",e=>{const s="- Authentication Failure\n- Session has been reset, please try again";console.log(s),console.log(`msg_failure: ${e}`),fs.rm(SESSION_FILE_PATH,{force:!0},e=>{e&&console.log(e),console.log(`${SESSION_FILE_PATH} is deleted!`),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:s,sessionId:SESSION_ID}))})}),client.on("ready",async()=>{let e="- WhatsApp Client Library for .NET Developer";console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID})),e=`- Copyright (C) 2020-${(new Date).getFullYear()}. Kamarudin`,console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID})),e="- http://wa-net.coding4ever.net/",console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID})),e=`- WhatsApp Web version ${await client.getWWebVersion()}`,console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID})),e=`- Chrome version ${(await client.pupPage.browser().version()).toString().split("/")[1]}`,console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID})),await waitFor(4e3),e="- Ready",console.log(e),signalRClient.connection.hub.invoke(serverHub,"Startup",JSON.stringify({message:e,sessionId:SESSION_ID}))}),client.on("disconnected",e=>{console.log("Client was logged out",e)}),client.on("change_state",e=>{console.log("CHANGE STATE",e),signalRClient.connection.hub.invoke(serverHub,"ChangeState",JSON.stringify({state:e,sessionId:SESSION_ID}))});const replyAsync=async(e,s,n,i)=>{try{return!!e.endsWith("@g.us")||await i.isRegisteredUser(e)?(await i.sendMessage(e,s,{quotedMessageId:n}),`true_${e}_${s}`):`false_${e}_${s}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}`},sendTextAsync=async(e,s,n)=>{try{return!!e.endsWith("@g.us")||await n.isRegisteredUser(e)?(await n.sendMessage(e,s),`true_${e}_${s}`):`false_${e}_${s}`}catch(e){console.log("error ...."),console.log(e)}return`false_${e}_${s}`},sendImageOrFileAsync=async(e,s,n,i)=>{try{if(!!e.endsWith("@g.us")||await i.isRegisteredUser(e)){const t=MessageMedia.fromFilePath(s);return await i.sendMessage(e,t,{caption:n}),`true_${e}_${n}`}return`false_${e}_${n}`}catch(e){console.log(e)}return`false_${e}_${n}`},sendImageOrFileFromUrlAsync=async(e,s,n,i)=>{try{if(!!e.endsWith("@g.us")||await i.isRegisteredUser(e))try{const t=await MessageMedia.fromUrl(s);return await i.sendMessage(e,t,{caption:n}),`true_${e}_${n}`}catch(e){console.log(e)}return`false_${e}_${n}`}catch(e){console.log(e)}return`false_${e}_${n}`};module.exports={client:client,SESSION_FILE_PATH:SESSION_FILE_PATH,sendTextAsync:sendTextAsync,sendImageOrFileAsync:sendImageOrFileAsync,sendImageOrFileFromUrlAsync:sendImageOrFileFromUrlAsync,replyAsync:replyAsync};