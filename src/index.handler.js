require("dotenv").config();const path=require("path"),fs=require("fs"),mime=require("mime-types"),{vcardToJSON:vcardToJSON,waitFor:waitFor,asyncForEach:asyncForEach,saveMedia:saveMedia}=require("./utils"),{MessageTypes:MessageTypes,Location:Location,List:List,Buttons:Buttons}=require("whatsapp-web.js"),{SESSION_ID:SESSION_ID,IMAGE_AND_DOCUMENT_PATH:IMAGE_AND_DOCUMENT_PATH}=process.env,getContact=async(e,s)=>{let a=void 0;try{a=await s.getContactById(e)}catch(e){console.log(`ex: ${e}`)}return a},connectedHandler=()=>{const{client:e}=require("./wa.utils"),{signalRClient:s,serverHub:a}=require("./signalr.util");console.log("SignalR client connected."),s.connection.hub.invoke(a,"Startup",JSON.stringify({message:"- Initialize...",sessionId:SESSION_ID}));(async()=>{try{console.log("Initialize..."),await e.initialize()}catch(e){console.error("initialize error ...."),s.connection.hub.invoke(a,"Startup",JSON.stringify({message:new String(e),sessionId:SESSION_ID}))}})(),e.on("group_join",async t=>{const n=await getContact(t.chatId,e),i={id:n.id._serialized?n.id._serialized:"",name:n.name?n.name:"",recipients:void 0};let o=[];for(const s of t.recipientIds){const a=await getContact(s,e);let t={};t=a?{id:a.id._serialized?a.id._serialized:"",name:a.name?a.name:"",shortName:a.shortName?a.shortName:"",pushname:a.pushname?a.pushname:""}:{id:s,name:"",shortName:"",pushname:""},o.push(t)}i.recipients=o,s.connection.hub.invoke(a,"GroupJoin",JSON.stringify({groupNotification:i,sessionId:SESSION_ID}))}),e.on("group_leave",async t=>{const n=await getContact(t.chatId,e),i={id:n.id._serialized?n.id._serialized:"",name:n.name?n.name:"",recipients:void 0};let o=[];for(const s of t.recipientIds){const a=await getContact(s,e);let t={};t=a?{id:a.id._serialized?a.id._serialized:"",name:a.name?a.name:"",shortName:a.shortName?a.shortName:"",pushname:a.pushname?a.pushname:""}:{id:s,name:"",shortName:"",pushname:""},o.push(t)}i.recipients=o,s.connection.hub.invoke(a,"GroupLeave",JSON.stringify({groupNotification:i,sessionId:SESSION_ID}))}),e.on("message",async t=>{if("status@broadcast"===t.from)return void console.log("update status di skip aja");if(!t.body&&!t.hasMedia)return void console.log("pesan kosong");try{(await t.getChat()).sendSeen()}catch(e){console.log(`ex: ${e}`)}let n={},i="";const o=t.hasMedia&&IMAGE_AND_DOCUMENT_PATH;if(o)try{i=(n=await t.downloadMedia()).mimetype}catch(e){console.log(`ex: ${e}`)}const r=t.from.endsWith("@g.us"),d=await getContact(t.from,e);let c=void 0;r&&(c=await getContact(t.author,e));const l={id:t.id._serialized,sessionId:SESSION_ID,content:t.body?t.body:"",type:t.type?t.type:"",from:t.from?t.from:"",to:t.to?t.to:"",sender:r?void 0:{id:d.id._serialized?d.id._serialized:"",name:d.name?d.name:"",shortName:d.shortName?d.shortName:"",pushname:d.pushname?d.pushname:""},group:r?{id:d.id._serialized?d.id._serialized:"",name:d.name?d.name:"",sender:{id:c.id._serialized?c.id._serialized:"",name:c.name?c.name:"",shortName:c.shortName?c.shortName:"",pushname:c.pushname?c.pushname:""}}:void 0,unixTimestamp:t.timestamp?t.timestamp:0,filename:o?`${t.timestamp}.${mime.extension(i)}`:"",location:t.type===MessageTypes.LOCATION?t.location:void 0,vcards:t.type===MessageTypes.CONTACT_CARD||t.type===MessageTypes.CONTACT_CARD_MULTI?[]:void 0,vcardFilenames:t.type===MessageTypes.CONTACT_CARD||t.type===MessageTypes.CONTACT_CARD_MULTI?[]:void 0};if(l.type!==MessageTypes.CONTACT_CARD&&l.type!==MessageTypes.CONTACT_CARD_MULTI&&l.type!==MessageTypes.LOCATION||(l.content=""),l.type===MessageTypes.CONTACT_CARD&&(l.vcards.push(vcardToJSON(t.body)),IMAGE_AND_DOCUMENT_PATH)){const{fn:e}=l.vcards[0],s=`${l.unixTimestamp}_${e}.vcf`;l.vcardFilenames.push(s)}if(l.type===MessageTypes.CONTACT_CARD_MULTI){let e=0;for(const s of t.vCards){if(l.vcards.push(vcardToJSON(s)),IMAGE_AND_DOCUMENT_PATH){const{fn:s}=l.vcards[e],a=`${l.unixTimestamp}_${s}.vcf`;l.vcardFilenames.push(a)}e++}}if(s.connection.hub.invoke(a,"ReceiveMessage",JSON.stringify({message:l,sessionId:SESSION_ID})),o){const{data:e}=n,s=new Buffer.from(e,"base64");saveMedia(IMAGE_AND_DOCUMENT_PATH,l.filename,s)}if(t.type===MessageTypes.CONTACT_CARD&&IMAGE_AND_DOCUMENT_PATH){const e=l.vcardFilenames[0];saveMedia(IMAGE_AND_DOCUMENT_PATH,e,t.body)}if(l.type===MessageTypes.CONTACT_CARD_MULTI&&IMAGE_AND_DOCUMENT_PATH){let e=0;for(const s of t.vCards){const a=l.vcardFilenames[e];saveMedia(IMAGE_AND_DOCUMENT_PATH,a,s),e++}}})},onSetStatusHandler=async e=>{const{client:s,sendTextAsync:a,sendImageOrFileAsync:t,sendImageOrFileFromUrlAsync:n}=require("./wa.utils"),i=JSON.parse(e),{sessionId:o,send_to:r,message:d,type:c,attachmentOrUrl:l}=i;o===SESSION_ID?"image"===c?await t(r,l,d,s):"url"===c?await n(r,l,d,s):await a(r,d,s):console.log("beda sessi enggak usah diproses")},onSendMessageHandler=async e=>{const{client:s,sendTextAsync:a,sendListOrButtonAsync:t,sendImageOrFileAsync:n,sendImageOrFileFromUrlAsync:i,replyAsync:o}=require("./wa.utils"),{signalRClient:r,serverHub:d}=require("./signalr.util"),c=JSON.parse(e),{sessionId:l,send_to:g,message:u,type:m,attachmentOrUrl:S,quotedMessageId:p}=c;if(l===SESSION_ID)if("image"===m||"file"===m){const e=(await n(g,S,u,s)).toString().split("_"),[a,t,i]=e;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:t,message:i},sessionId:SESSION_ID}))}else if("url"===m){const e=(await i(g,S,u,s)).toString().split("_"),[a,t,n]=e;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:a,send_to:t,message:n},sessionId:SESSION_ID}))}else if("location"===m){const e=JSON.parse(u),t=new Location(e.latitude,e.longitude,e.description);let n="";const i=(n=p?await o(g,t,p,s):await a(g,t,s)).toString().split("_"),[c,l,m]=i;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:c,send_to:l,message:m},sessionId:SESSION_ID}))}else if("list"===m){const e=JSON.parse(u),a=new List(e.content,e.listText,e.sections,e.title),n=(await t(g,a,m,s)).toString().split("_"),[i,o,c]=n;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:i,send_to:o,message:c},sessionId:SESSION_ID}))}else if("button"===m){const e=JSON.parse(u),a=new Buttons(e.content,e.items,e.title),n=(await t(g,a,m,s)).toString().split("_"),[i,o,c]=n;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:i,send_to:o,message:c},sessionId:SESSION_ID}))}else{let e="";const t=(e=p?await o(g,u,p,s):await a(g,u,s)).toString().split("_"),[n,i,c]=t;r.connection.hub.invoke(d,"SendMessageStatus",JSON.stringify({messageStatus:{status:n,send_to:i,message:c},sessionId:SESSION_ID}))}else console.log("beda sessi enggak usah diproses")},onBroadcastMessageHandler=async(e,s)=>{const{client:a,sendTextAsync:t,sendImageOrFileAsync:n,sendImageOrFileFromUrlAsync:i}=require("./wa.utils"),{signalRClient:o,serverHub:r}=require("./signalr.util"),d=JSON.parse(e);await asyncForEach(d,async e=>{const{sessionId:d,send_to:c,message:l,type:g,attachmentOrUrl:u}=e;if(d===SESSION_ID){if("image"===g||"file"===g){const e=(await n(c,u,l,a)).toString().split("_"),[s,t,i]=e;o.connection.hub.invoke(r,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:t,message:i},sessionId:SESSION_ID}))}else if("url"===g){const e=(await i(c,u,l,a)).toString().split("_"),[s,t,n]=e;o.connection.hub.invoke(r,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:t,message:n},sessionId:SESSION_ID}))}else if("location"===g){const e=JSON.parse(l),s=new Location(e.latitude,e.longitude,e.description),n=(await t(c,s,a)).toString().split("_"),[i,d,g]=n;o.connection.hub.invoke(r,"SendMessageStatus",JSON.stringify({messageStatus:{status:i,send_to:d,message:g},sessionId:SESSION_ID}))}else{const e=(await t(c,l,a)).toString().split("_"),[s,n,i]=e;o.connection.hub.invoke(r,"SendMessageStatus",JSON.stringify({messageStatus:{status:s,send_to:n,message:i},sessionId:SESSION_ID}))}await waitFor(s)}})},onGrabContactHandler=async e=>{const{client:s}=require("./wa.utils"),{signalRClient:a,serverHub:t}=require("./signalr.util"),n=JSON.parse(e),{sessionId:i}=n;if(i!==SESSION_ID)return void console.log("beda sessi enggak usah diproses");let o=[];try{o=await s.getContacts()}catch(e){console.log(`ex: ${e}`)}let r=[];o.forEach(e=>{if(!e.isMe){const s=e.id._serialized.toString().split("@");if(s[0].length>5&&"c.us"===s[1]){const s={id:e.id._serialized?e.id._serialized:"",name:e.name?e.name:"",shortName:e.shortName?e.shortName:"",pushname:e.pushname?e.pushname:"",verifiedName:e.verifiedName?e.verifiedName:"",sessionId:SESSION_ID};"status@broadcast"!==s.id&&r.push(s),100===r.length&&(a.connection.hub.invoke(t,"ReceiveContacts",JSON.stringify({contacts:r,sessionId:SESSION_ID})),r=[])}}}),r.push({id:"status@broadcast"}),a.connection.hub.invoke(t,"ReceiveContacts",JSON.stringify({contacts:r,sessionId:SESSION_ID}))},onGrabGroupHandler=async e=>{const{client:s}=require("./wa.utils"),{signalRClient:a,serverHub:t}=require("./signalr.util"),n=JSON.parse(e),{sessionId:i}=n;if(i!==SESSION_ID)return void console.log("beda sessi enggak usah diproses");let o=[];try{o=await s.getChats()}catch(e){console.log(`ex: ${e}`)}let r=[];o.forEach(e=>{if(e.isGroup){const s={id:e.id._serialized?e.id._serialized:"",name:e.name?e.name:"",sessionId:SESSION_ID};r.push(s)}}),r.push({id:"status@broadcast"}),a.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:r,sessionId:SESSION_ID}))},onGrabGroupAndMemberHandler=async e=>{const{client:s}=require("./wa.utils"),{signalRClient:a,serverHub:t}=require("./signalr.util"),n=JSON.parse(e),{sessionId:i}=n;if(i!==SESSION_ID)return void console.log("beda sessi enggak usah diproses");let o=[];try{o=await s.getChats()}catch(e){console.log(`ex: ${e}`)}let r=[];o.forEach(e=>{if(e.isGroup){let s=[];e.groupMetadata.participants.forEach(e=>{const a={id:e.id._serialized?e.id._serialized:"",name:"",shortName:"",pushname:""};s.push(a)});const a={id:e.id._serialized?e.id._serialized:"",name:e.name?e.name:"",sessionId:SESSION_ID,members:s};r.push(a)}});let d=[];for(const e of r){for(const a of e.members)try{const e=await getContact(a.id,s);a.name=e.name?e.name:"",a.shortName=e.shortName?e.shortName:"",a.pushname=e.pushname?e.pushname:""}catch(e){console.log("onGrabGroupAndMemberHandler error ...."),console.log(`ex: ${e}`)}d.push(e),1===d.length&&(a.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:d,sessionId:SESSION_ID})),d=[])}d.push({id:"status@broadcast"}),a.connection.hub.invoke(t,"ReceiveGroups",JSON.stringify({groups:d,sessionId:SESSION_ID}))},onArchiveChatHandler=async e=>{const{client:s}=require("./wa.utils"),a=JSON.parse(e),{sessionId:t,phoneNumber:n}=a;if(t===SESSION_ID)if(n){(await s.getChatById(n)).archive()}else{const e=await s.getChats();for(const s of e)await s.archive()}else console.log("beda sessi enggak usah diproses")},onDeleteChatHandler=async e=>{const{client:s}=require("./wa.utils"),a=JSON.parse(e),{sessionId:t,phoneNumber:n}=a;if(t===SESSION_ID)if(n){(await s.getChatById(n)).delete()}else{const e=await s.getChats();for(const s of e)await s.delete()}else console.log("beda sessi enggak usah diproses")},onDisconnectHandler=async e=>{const{signalRClient:s}=require("./signalr.util"),{client:a}=require("./wa.utils"),t=JSON.parse(e),{sessionId:n}=t;if(n===SESSION_ID){try{await a.destroy()}catch(e){console.log(`ex: ${e}`)}setTimeout(()=>process.exit(),500),s.end()}else console.log("beda sessi enggak usah diproses")},onLogoutHandler=async e=>{const{signalRClient:s}=require("./signalr.util"),{client:a}=require("./wa.utils"),t=JSON.parse(e),{sessionId:n}=t;if(n===SESSION_ID){try{await a.logout();const e=path.join(path.resolve("./session"),`${SESSION_ID}.json`);fs.rm(e,{force:!0},s=>{s&&console.log(s),console.log(`${e} is deleted!`)})}catch(e){console.log(`ex: ${e}`)}setTimeout(()=>process.exit(),500),s.end()}else console.log("beda sessi enggak usah diproses")},onGetAllMessageHandler=async e=>{const{client:s}=require("./wa.utils"),{signalRClient:a,serverHub:t}=require("./signalr.util"),n=JSON.parse(e),{sessionId:i,phoneNumber:o,limit:r}=n;if(i!==SESSION_ID)return void console.log("beda sessi enggak usah diproses");let d=[];if(o){const e=await s.getChatById(o);if(!e)return void console.log("belum ada chat, enggak usah diproses");const n=await e.fetchMessages({limit:r});for(const e of n){if(!e.body){console.log("pesan kosong");continue}const n=e.from.endsWith("@g.us"),i=await getContact(e.from,s);let o=void 0;n&&(o=await getContact(e.author,s));const r={id:e.id._serialized,sessionId:SESSION_ID,content:e.body?e.body:"",type:e.type?e.type:"",from:e.from?e.from:"",to:e.to?e.to:"",sender:n?void 0:{id:i.id._serialized?i.id._serialized:"",name:i.name?i.name:"",shortName:i.shortName?i.shortName:"",pushname:i.pushname?i.pushname:""},group:n?{id:i.id._serialized?i.id._serialized:"",name:i.name?i.name:"",sender:{id:o.id._serialized?o.id._serialized:"",name:o.name?o.name:"",shortName:o.shortName?o.shortName:"",pushname:o.pushname?o.pushname:""}}:void 0,unixTimestamp:e.timestamp?e.timestamp:0,filename:"",location:e.type===MessageTypes.LOCATION?e.location:void 0,vcards:e.type===MessageTypes.CONTACT_CARD||e.type===MessageTypes.CONTACT_CARD_MULTI?[]:void 0};if(r.type!==MessageTypes.CONTACT_CARD&&r.type!==MessageTypes.CONTACT_CARD_MULTI&&r.type!==MessageTypes.LOCATION||(r.content=""),r.type===MessageTypes.CONTACT_CARD&&r.vcards.push(vcardToJSON(e.body)),r.type===MessageTypes.CONTACT_CARD_MULTI)for(const s of e.vCards)r.vcards.push(vcardToJSON(s));d.push(r),50===d.length&&(a.connection.hub.invoke(t,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])}d.length>0&&(a.connection.hub.invoke(t,"ReceiveMessages",JSON.stringify({messages:d,sessionId:SESSION_ID})),d=[])}},onGetUnreadMessageHandler=async e=>{const{client:s}=require("./wa.utils"),{signalRClient:a,serverHub:t}=require("./signalr.util"),n=JSON.parse(e),{sessionId:i}=n;if(i!==SESSION_ID)return void console.log("beda sessi enggak usah diproses");let o=[];try{o=await s.getChats()}catch(e){console.log(`ex: ${e}`)}let r=[];for(const e of o)if(e.sendSeen(),e.unreadCount>0){const n=await e.fetchMessages({limit:e.unreadCount});for(const e of n){if(!e.body){console.log("pesan kosong");continue}const n=e.from.endsWith("@g.us"),i=await getContact(e.from,s);let o=void 0;n&&(o=await getContact(e.author,s));const d={id:e.id._serialized,sessionId:SESSION_ID,content:e.body?e.body:"",type:e.type?e.type:"",from:e.from?e.from:"",to:e.to?e.to:"",sender:n?void 0:{id:i.id._serialized?i.id._serialized:"",name:i.name?i.name:"",shortName:i.shortName?i.shortName:"",pushname:i.pushname?i.pushname:""},group:n?{id:i.id._serialized?i.id._serialized:"",name:i.name?i.name:"",sender:{id:o.id._serialized?o.id._serialized:"",name:o.name?o.name:"",shortName:o.shortName?o.shortName:"",pushname:o.pushname?o.pushname:""}}:void 0,unixTimestamp:e.timestamp?e.timestamp:0,filename:"",location:e.type===MessageTypes.LOCATION?e.location:void 0,vcards:e.type===MessageTypes.CONTACT_CARD||e.type===MessageTypes.CONTACT_CARD_MULTI?[]:void 0};if(d.type!==MessageTypes.CONTACT_CARD&&d.type!==MessageTypes.CONTACT_CARD_MULTI&&d.type!==MessageTypes.LOCATION||(d.content=""),d.type===MessageTypes.CONTACT_CARD&&d.vcards.push(vcardToJSON(e.body)),d.type===MessageTypes.CONTACT_CARD_MULTI)for(const s of e.vCards)d.vcards.push(vcardToJSON(s));console.log(`msg: ${JSON.stringify(d)}`),r.push(d),100===r.length&&(a.connection.hub.invoke(t,"ReceiveMessages",JSON.stringify({messages:r,sessionId:SESSION_ID})),r=[])}}r.length>0&&(a.connection.hub.invoke(t,"ReceiveMessages",JSON.stringify({messages:r,sessionId:SESSION_ID})),r=[])};module.exports={connectedHandler:connectedHandler,onSetStatusHandler:onSetStatusHandler,onSendMessageHandler:onSendMessageHandler,onBroadcastMessageHandler:onBroadcastMessageHandler,onGrabContactHandler:onGrabContactHandler,onGrabGroupHandler:onGrabGroupHandler,onGrabGroupAndMemberHandler:onGrabGroupAndMemberHandler,onArchiveChatHandler:onArchiveChatHandler,onDeleteChatHandler:onDeleteChatHandler,onGetUnreadMessageHandler:onGetUnreadMessageHandler,onGetAllMessageHandler:onGetAllMessageHandler,onDisconnectHandler:onDisconnectHandler,onLogoutHandler:onLogoutHandler};